blocks:
  argo_ingress: https://raw.githubusercontent.com/polyseam/cndi/main/src/templates/fragments/argo-ingress.yaml
  
  ec2_nodes:
    - name: x-airflow-node
      kind: ec2
      role: leader
      instance_type: t3.large
      volume_size: 128
    - name: y-airflow-node
      kind: ec2
      volume_size: 128
    - name: z-airflow-node
      kind: ec2
      volume_size: 128

  eks_nodes:
      - name: airflow-nodes
        kind: eks
        instance_type: t3.large
        volume_size: 128
        min_count: 1
        max_count: 3

  gcp_nodes:
      - name: x-airflow-node  
        kind: gcp
        role: leader
        instance_type: n2-standard-2
        volume_size: 128
      - name: y-airflow-node
        kind: gcp
        volume_size: 128
      - name: z-airflow-node
        kind: gcp
        volume_size: 128

  azure_nodes:
      - name: x-airflow-node
        kind: azure
        role: leader
        instance_type: Standard_D2_v3
        volume_size: 128
      - name: y-airflow-node
        kind: azure
        volume_size: 128
      - name: z-airflow-node
        kind: azure
        volume_size: 128


prompts:
  # because the "kind" is used in every template, it currently lives before this chronologically
  - name: kind
    default: ec2
    message: 'Please enter the kind of node you want to use:'
    type: Select
    options:
      - ec2
      - eks
      - gcp
      - azure
      - dev

  - name: dagRepoUrl
    default: 'https://github.com/polyseam/demo-dag-bag'
    message: 'Please enter the url of the git repo containing your dags:'
    type: Input
    validator:
      named: URL

  # this enables the user to skip questions about dag credentials
  - name: separateGitSyncCredentials
    default: false
    message: >-
      Do you want to use separate git credentials for your DAG repo?
    type: Confirm
    next_prompt:
      _if_:
        response: separateGitSyncCredentials
        is:
          equal_to: false
        then: argocdDomainName
        # implicit else is the next prompt down

  - message: 'Please enter the username airflow should use to access your dag repo:'
    name: gitSyncUsername
    type: Input

  - message: 'Please enter the password airflow should use to access your dag repo:'
    name: gitSyncPassword
    type: Secret

  - name: argocdDomainName
    default: argocd.example.com
    message: 'Please enter the domain name you want argocd to be accessible on:'
    type: Input
    validators:
      - named: hostname

  - name: airflowDomainName
    default: airflow.example.com
    message: 'Please enter the domain name you want airflow to be accessible on:'
    type: Input
    validators:
      - named: hostname

  - message: 'Please enter the email address you want to use for lets encrypt:'
    default: admin@example.com
    name: letsEncryptClusterIssuerEmailAddress
    type: Input
    validators:
      - named: email

  - message: 'Please enter the postgresql password you want to use for your postgresql database:'
    default: password
    name: postgresqlPassword
    type: Secret
    validators:
      - named: minLength
        args:
          min: 8

outputs:
  cndi-config:
    cndi_version: v1
    infrastructure:
      cndi:
        cert_manager:
          email: '{{ $.cndi.prompts.responses.letsEncryptClusterIssuerEmailAddress }}'
        
        nodes:
          _block_by_name_:
            name: '$.cndi.blocks.{{ $.cndi.responses.kind }}_nodes'

    cluster_manifests:
      git-credentials-secret:
      # the choice is made between two manifests based on the response to the prompt
      # recursive '_if_'s can be avoided with some tolerance for repetition
        _if_: 
          response: separateGitSyncCredentials
          is:
            equal_to: true

          then:
            apiVersion: v1
            kind: Secret
            metadata:
              name: airflow-git-credentials
              namespace: airflow
            stringData:
              GIT_SYNC_USERNAME: $.cndi.secrets.seal(GIT_SYNC_USERNAME)
              GIT_SYNC_PASSWORD: $.cndi.secrets.seal(GIT_SYNC_PASSWORD)

          else:
            apiVersion: v1
            kind: Secret
            metadata:
              name: airflow-git-credentials
              namespace: airflow
            stringData:
              GIT_SYNC_USERNAME: $.cndi.secrets.seal(GIT_USERNAME)
              GIT_SYNC_PASSWORD: $.cndi.secrets.seal(GIT_PASSWORD)

      postgresql-connection-string-secret:
        apiVersion: v1
        kind: Secret
        metadata:
          name: postgresql-connection-string-secret
          namespace: airflow
        type: Opaque
        stringData:
          connection: $.cndi.secrets.seal(POSTGRESQL_CONNECTION_STRING)

      cnpg-cluster:
        apiVersion: postgresql.cnpg.io/v1
        kind: Cluster
        metadata:
          name: cnpg-airflow-cluster
          namespace: airflow
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
        spec:
          imageName: 'ghcr.io/cloudnative-pg/postgresql:15.2'
          instances: 3
          storage:
            size: 1Gi
          replicationSlots:
            highAvailability:
              enabled: true
          postgresql:
            pg_hba:
              - >-
                host airflow-pg admin all password
          bootstrap:
            initdb:
              database: 'airflow-pg'
              owner: 'admin'
              secret:
                name: cnpg-database-user-auth-secret
          superuserSecret:
            name: cnpg-cluster-superuser-auth-secret

      cnpg-cluster-superuser-auth-secret:
        apiVersion: v1
        kind: Secret
        metadata:
          name: cnpg-cluster-superuser-auth-secret
          namespace: airflow
        type: kubernetes.io/basic-auth
        stringData:
          username: $.cndi.secrets.seal(POSTGRESQL_CLUSTER_SUPERUSER)
          password: $.cndi.secrets.seal(POSTGRESQL_PASSWORD)

      cnpg-database-user-auth-secret:
        apiVersion: v1
        kind: Secret
        metadata:
          name: cnpg-database-user-auth-secret
          namespace: airflow
        type: kubernetes.io/basic-auth
        stringData:
          username: $.cndi.secrets.seal(POSTGRESQL_USER)
          password: $.cndi.secrets.seal(POSTGRESQL_PASSWORD)

      argo-ingress:
        _block_by_name_:
          name: argo_ingress

    applications:
      cnpg:
        targetRevision: 0.18.0
        destinationNamespace: cnpg-system
        repoURL: 'https://cloudnative-pg.github.io/charts'
        chart: cloudnative-pg
      airflow:
        targetRevision: 1.7.0
        destinationNamespace: airflow
        repoURL: 'https://airflow.apache.org'
        chart: airflow
        values:
          executor: LocalKubernetesExecutor
          data:
            metadataSecretName: postgresql-connection-string-secret
          postgresql:
            enabled: false
          dags:
            gitSync:
              enabled: true
              repo: '{{ $.cndi.prompts.responses.dagRepoUrl }}'
              credentialsSecret: airflow-git-credentials
              branch: main
              wait: 40
              subPath: dags
          config:
            webserver:
              expose_config: 'True'
              instance_name: Polyseam
              enable_proxy_fix: 'True'
              base_url: 'https://{{ $.cndi.prompts.responses.airflowDomainName }}'
            operators:
              default_owner: Polyseam
          ingress:
            web:
              enabled: true
              annotations:
                cert-manager.io/cluster-issuer: cluster-issuer
              hosts:
                - name: '{{ $.cndi.prompts.responses.airflowDomainName }}'
                  tls:
                    secretName: cluster-issuer-private-key
                    enabled: true
          logs:
            persistence:
              enabled: true
              size: 15Gi
          createUserJob:
            useHelmHooks: false
          migrateDatabaseJob:
            useHelmHooks: false
  env:
    extend_basic_env: '{{ $.cndi.prompts.responses.kind }}'
    entries:
      - type: Comment
        comment: PostgreSQL connection parameters
      - name: POSTGRESQL_DB
        value: 'airflow-pg'
      - name: POSTGRESQL_USER
        value: 'admin'
      - name: POSTGRESQL_PASSWORD
        value: '{{ $.cndi.prompts.responses.postgresqlPassword }}'
      - name: POSTGRESQL_PROTOCOL
        value: postgresql
      - name: POSTGRESQL_HOST
        value: cnpg-airflow-cluster-rw
      - name: POSTGRESQL_PORT
        value: '5432'
      - name: POSTGRESQL_CONNECTION_STRING
        value: >-
          postgresql://admin:{{
          $.cndi.prompts.responses.postgresqlPassword
          }}@cnpg-airflow-cluster-rw:5432/airflow-pg
      - name: POSTGRESQL_CLUSTER_SUPERUSER
        value: postgres
      - type: Comment
        comment: airflow-git-credentials secret values for DAG Storage
      - name: GIT_SYNC_USERNAME
        value: '{{ $.cndi.prompts.responses.gitSyncUsername }}'
      - name: GIT_SYNC_PASSWORD
        value: '{{ $.cndi.prompts.responses.gitSyncPassword }}'
  readme:
    extend_basic_readme: '{{ $.cndi.prompts.responses.kind }}'
    template_section: >-
      ## airflow


      This template deploys a fully functional
      [Airflow](https://airflow.apache.org) cluster using the [official Airflow
      Helm chart](https://github.com/apache/airflow/tree/main/chart) and an
      external production ready posgresql database
      [cloudnative-pg](https://github.com/cloudnative-pg/charts) 


      The default credentials for Airflow are: 


      username: `admin`

      password: `admin`
